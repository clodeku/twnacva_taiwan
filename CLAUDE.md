# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Taiwan NACVA (National Association for Career Vocational Organization) web application - a traditional JSP/Servlet CMS with admin management system.

- **Stack:** Java JSP, MySQL, Genesis Framework (Chinese custom framework)
- **Language:** Traditional Chinese (Taiwan)
- **Database:** MySQL with Proxool connection pooling

## Project Structure

```
twnacva_taiwan/
├── WEB-INF/
│   ├── web.xml                    # Deployment descriptor
│   ├── classes/
│   │   ├── app/res/               # Configuration (proxool.properties, config.properties)
│   │   └── local/beans/           # 25 auto-generated data model beans
│   ├── lib/                       # 29 JAR dependencies
│   └── jspf/                      # JSP fragments (reusable includes)
│       ├── config.jspf            # Global config - loaded by all pages
│       ├── db_info_name.jspf      # Table name mappings
│       └── mis/                   # Admin system fragments
├── web/                           # Public website (about, news, member, etc.)
├── mis/                           # Admin CMS system
│   ├── basic/                     # Content management (40+ JSPs)
│   └── system/                    # System admin (40+ JSPs)
├── uploads/                       # User-uploaded files
├── home.jsp                       # Main homepage
└── index.jsp                      # Welcome/splash page
```

## Key Configuration Files

| File | Purpose |
|------|---------|
| `WEB-INF/classes/app/res/proxool.properties` | Database connection (localhost:3306, comm_twnacva_taiwan) |
| `WEB-INF/classes/app/res/config.properties` | SMTP, upload paths, site titles |
| `WEB-INF/jspf/config.jspf` | XSS protection, language support, session management |
| `WEB-INF/jspf/db_info_name.jspf` | Database table name constants |

## Database Access Pattern

Uses Genesis Framework's SqlManager ORM:

```java
SqlManager app_sm = new SqlManager();
TableRecord record = app_sm.select(tableName, "field=?", new Object[]{value});
Vector<TableRecord> records = app_sm.selectAll(tableName, whereClause, params, "order_field ASC");
app_sm.update(record);
app_sm.insert(record);
```

## Core Tables

- `ad_profile` - Banners, ads, galleries
- `content_profile` - Website content & downloads
- `down_menu` - Navigation categories
- `news_profile` - News articles
- `member_profile` - Member accounts
- `activity_information` / `activity_apply` - Events & registrations
- `admin_user` / `admin_map_function` - Admin accounts & permissions

## Multi-language Support

- Language codes: `tw` (default), `en`, `jp`
- Session variable: `web_language` or `app_locale`
- All content tables have `*_lang` field for filtering

## Build & Deployment

No Maven/Gradle - traditional WAR-ready structure with pre-compiled classes.

**Deployment:**
1. Configure `proxool.properties` with MySQL credentials
2. Configure `config.properties` with SMTP and site settings
3. Deploy to Tomcat/application server webapps directory
4. Ensure `/uploads` directory is writable

**Access Points:**
- Public site: `/home.jsp`
- Admin login: `/mis/index.jsp`

## Bean Classes

Located in `local/beans/` - auto-generated by `com.genesis.util.BeanCreator`. Do not manually edit; regenerate if schema changes.

## Dependencies

Key libraries in WEB-INF/lib:
- `genesis_2.4.jar` - Core framework
- `mysql-connector-java-5.0.6-bin.jar` - MySQL JDBC
- `proxool-0.9.1.jar` - Connection pooling
- `poi-4.1.2.jar` - Excel support
- `AllPay.Payment.Integration.jar` - Payment gateway
- `genemail_1.8.jar` - Email service

## Authentication Systems

**Member Login** (`/web/member/log_in.jsp`):
- Session: `session.getAttribute("member")` returns TableRecord
- Password: 8-30 chars, requires digit + uppercase + lowercase

**Admin Login** (`/mis/login.jsp`):
- CAPTCHA required: `session.getAttribute("rand")`
- Session variables: `app_user`, `top_function`, `left_function`, `lastlogin`
- Audit logging to `admin_log` table

## File Upload Paths

Uploads stored in `/uploads/{page_code}/{language}/`:
- Members: `/uploads/member/tw/`, `/uploads/member/en/`
- Activities: `/uploads/activity/tw/`
- News: `/uploads/news/tw/`
- Banners: `/uploads/banner/tw/`

## Email Templates

Located in `/web/mail/`:
- `add_member.jsp` - Registration confirmation
- `forget_password.jsp` - Password reset
- `activity_apply.jsp` - Activity registration
- `course_apply.jsp` - Course registration
- `tacva.jsp`, `nacva.jsp` - Membership notifications

## Key Form Processing

| Form | Submit To | Purpose |
|------|-----------|---------|
| Member registration | `/web/member/member_update.jsp` | Insert to member_profile |
| Activity registration | `/web/activity/activity_apply_update.jsp` | Insert to activity_apply |
| Course registration | `/web/course/course_apply_update.jsp` | Insert to activity_apply |
| Admin content CRUD | `/mis/basic/*_update.jsp` | Various tables |

## Session Variables

| Variable | Scope | Purpose |
|----------|-------|---------|
| `member` | Web | Logged-in member TableRecord |
| `web_language` | Web | Language preference (tw/en) |
| `app_user` | Admin | Admin user TableRecord |
| `rand` | Both | CAPTCHA verification string |
| `top_function` | Admin | Permitted top menu items |
| `left_function` | Admin | Permitted submenu items |
